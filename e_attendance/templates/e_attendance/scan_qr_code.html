{% extends "e_attendance/layout.html" %}

{% block title %}Scan QR Code{% endblock %}

{% load static %}

{% block script %}
<script src="{% static 'e_attendance/js/html5-qrcode.min.js' %}" type="text/javascript"></script>
<script src="{% static 'e_attendance/js/getCookie.js' %}" type="text/javascript"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        // This function will run when a QR code is detected.
        function onScanSuccess(decodedText) {
            document.querySelector("#html5-qrcode-button-camera-stop").click();
            // Make a POST request to the url inside the QR code.
            let obj = JSON.parse(decodedText);
            options = {
                method: "POST",
                mode: "same-origin",
                headers: {
                    "X-CSRFToken": getCookie('csrftoken'),
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ class_meeting_id: obj.class_meeting_id })
            };
            fetch(obj.path, options)
                .then(res => {
                    // If attendance is success, redirect to the attendance table of the class.
                    if (res.ok) {
                        res.json()
                            .then(obj => {
                                // To navigate to a new URL:                            
                                window.location.href = `/class_attendances/${obj.class_id}`;
                            });
                    }
                    else {
                        location.reload();
                    }
                });
        }

        function onScanFailure(error) {
            //console.warn(`Code scan error = ${error}`);
        }

        let config = {
            qrbox: { width: 300, height: 300 }
        };

        let html5QrcodeScanner = new Html5QrcodeScanner("reader", config, false);
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    })
</script>
{% endblock %}

{% block body %}
<div id="reader" style="max-width: 576px; margin-inline: auto;"></div>
{% endblock %}